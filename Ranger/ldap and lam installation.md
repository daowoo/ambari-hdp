# LDAP安装和LAM部署
## 概念
LDAP是轻量目录访问协议，Lightweight Directory Access Protocol，它从X.500目录访问协议的基础上发展过来，目前版本是3.0。
与LDAP一样提供类似的目录服务软件还有ApacheDS、Active Directory、Red Hat Directory Service。

## 目录服务
目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象Linux/Unix系统中的文件目录一样。
目录数据库和关系数据库不同，它有优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。所以目录天生是用来查询的，就好象它的名字一样。

目录服务是由目录数据库和一套访问协议组成的系统。类似以下的信息适合储存在目录中：
> 企业员工信息，如姓名、电话、邮箱等
> 公用证书和安全密钥
> 公司的物理设备信息，如服务器，它的IP地址、存放位置、厂商、购买时间等

## 特点
* LDAP的结构用树来表示，而不是用表格。正因为这样，就不能用SQL语句了
* LDAP可以很快地得到查询结果，不过在写方面，就慢得多
* LDAP提供了静态数据的快速查询方式
* Client/server模型，Server 用于存储数据，Client提供操作目录信息树的工具
* 这些工具可以将数据库的内容以文本格式（LDAP 数据交换格式，LDIF）呈现在您的面前
* LDAP是一种开放Internet标准，LDAP协议是跨平台的Interent协议

## 操作系统环境
`CentOS RELESE 7.1`

## 基础环境准备
* 配置HOSTNAME
```shell
hostnamectl set-hostname sldap.daowoo.com
```

* 配置DNS，关闭NetworkManager服务
```shell
sudo systemctl restart NetworkManager.service
sudo cat << eof > /etc/resolv.conf
# Generated by NetworkManager
search daowoo.com
nameserver 192.168.85.200
eof
```

* 关闭防火墙
```shell
sudo systemctl disable firewalld.service
sudo systemctl stop firewalld.service
setenforce 0
sudo sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
```

* 配置yum源仓库
```shell
sudo mv /etc/yum.repos.d /etc/yum.repos.d.bak
sudo mkdir /etc/yum.repos.d
sudo curl -o /etc/yum.repos.d/local.repo http://192.168.85.200/resource/local.repo
sudo curl -o /etc/yum.repos.d/CentOS7-Base-aliyun.repo http://192.168.85.200/resource/CentOS7-Base-aliyun.repo
```

* 安装工具包
```shell
sudo yum install tree -y
sudo yum install wget -y
sudo yum install bash-completion -y
sudo yum install yum-utils -y
```

* 配置NTP
```shell
sudo yum install ntp -y
sudo sed -i "s/server [0-3].centos.*/server 192.168.85.200/" /etc/ntp.conf
sudo systemctl start ntpd.service
sudo systemctl enable ntpd.service
sudo timedatectl set-ntp yes

ntpdate -u 192.168.85.200
ntpq -p
```

## 搭建openldap服务器
### 安装openldap软件包
安装过程中会自动在系统中创建`ldap`用户，还可以通过`rpm -qa |grep openldap`命令来查看具体安装了哪些与openldap相关的包。注意，如果要以主从方式搭建openldap服务器，还需安装与其有很大关系的`compat-openldap`包。

```shell
yum install -y openldap             #配置文件、文档和ldap lib
yum install -y openldap-clients     #ldap客户端
yum install -y openldap-servers     #ldap服务端
yum install -y migrationtools       #数据迁移工具，可选
```

### openldap的配置文件介绍
```shell
[root@sldap openldap-servers]# tree /etc/openldap/ -L 1
/etc/openldap/
|-- certs  #存放ssl密钥文件，管理员用户密码文件的目录
|-- check_password.conf
|-- ldap.conf
|-- schema     #OpenLDAP的schema存放的地方
|-- slapd.conf #主配置文件，记录根域信息，管理员名称，密码，日志，权限等
`-- slapd.d   #这下面是slapd.conf配置信息生成的文件，每修改一次配置信息，这里的东西就要重新生成
```
注意：旧版本的OpenLDAP配置文件是slapd.conf，而新版本的OpenLDAP服务运行时并不会读取该配置文件，而是从slapd.d目录（一般与slapd.conf在同一目录下）中读取相关信息，我们需要把该目录下的数据删掉，然后利用我们在slapd.conf里配置的信息重新生成配置数据。

```shell
[root@sldap openldap-servers]# tree /usr/share/openldap-servers/
/usr/share/openldap-servers/  #openldap的配置模板目录
|-- DB_CONFcIG.example
`-- slapd.ldif

[root@sldap ldap]# tree /var/lib/ldap/
/var/lib/ldap/      #openldap的数据库目录
|-- alock
|-- cn.bdb
|-- __db.001
|-- __db.002
|-- __db.003
|-- DB_CONFIG
|-- dn2id.bdb
|-- gidNumber.bdb
|-- id2entry.bdb
|-- log.0000000001
|-- loginShell.bdb
|-- memberUid.bdb
|-- nisMapName.bdb
|-- objectClass.bdb
|-- ou.bdb
|-- uid.bdb
`-- uidNumber.bdb
```
注意：如果采用bdb/hdb作为后端的数据库，则需要拷贝DB_CONFIG文件到数据库目录`/var/lib/ldap/`中。

```shell
default port: 389  #明文数据传输
ssl     port: 636  #密文数据传输
```

### openldap的配置过程
首先要生成经加密处理后的明文密码，请记住加密后的密码字符串，之后的过程中会使用到。
```shell
slappasswd -s bigdata
{SSHA}AcVRbrzu8IZECX5GIGfigXr4k9fhptN7   #bigdata加密后的生成的密文
```

我们采用bdb来作为后端数据库，拷贝DB_CONFIG文件到数据库目录中。
```shell
cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
```

然后编辑slapd.conf配置文件
```shell
[root@sldap ldap]# cat /etc/openldap/slapd.conf
#include 行代表当前OpenLDAP 服务包含的schema 文件
include		/etc/openldap/schema/core.schema
include 	/etc/openldap/schema/collective.schema
include 	/etc/openldap/schema/corba.schema
include 	/etc/openldap/schema/cosine.schema
include 	/etc/openldap/schema/duaconf.schema
include		/etc/openldap/schema/dyngroup.schema
include 	/etc/openldap/schema/inetorgperson.schema
include 	/etc/openldap/schema/java.schema
include 	/etc/openldap/schema/misc.schema
include 	/etc/openldap/schema/nis.schema
include 	/etc/openldap/schema/openldap.schema
include 	/etc/openldap/schema/pmi.schema
include		/etc/openldap/schema/ppolicy.schema

# OpenLDAP 进程启动时，pid 文件存放路径
pidfile  /var/run/openldap/slapd.pid

# OpenLDAP 参数文件存放的路径。
argsfile /var/run/openldap/slapd.args

# 日志文件路径
loglevel 1
logfile  /var/log/slapd/slapd.log

# 传输加密的配置信息，暂时不启用ssl传输
#TLSCACertificatePath /etc/openldap/certs
#TLSCertificateFile "\"OpenLDAP Server\""
#TLSCertificateKeyFile /etc/openldap/certs/password

# 允许自身使用passwd命令修改密码，并允许授权用户查看信息
access to *
        by self write
        by dn="cn=admin,dc=daowoo,dc=com" write
        by * read

# cn=config账户权限，若不设置将无法使用ldapmodify -Q -Y EXTERNAL命令修改db配置文件
database config
access to *
        by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
        by * none
database monitor
access to *
        by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read
        by dn.exact="cn=admin,dc=daowoo,dc=com" read
        by * none

# 指定OpenLDAP 数据库类型。
database	bdb

# 指定OpenLDAP 服务域名（DN）
suffix		"dc=daowoo,dc=com"

# 指定OpenLDAP 服务管理员信息。
rootdn		"cn=admin,dc=daowoo,dc=com"

# 指定OpenLDAP 服务管理员密码，使用slappasswd -s your_password来获取加密密码
# 这里的rootpw必须顶格写，而且与后面的密码文件用Tab键隔开
rootpw		{SSHA}AcVRbrzu8IZECX5GIGfigXr4k9fhptN7

# 指定OpenLDAP 数据库文件的存放目录。
directory	/var/lib/ldap

# 创建OpenLDAP 索引。
index objectClass                       eq,pres
index ou,cn,mail,surname,givenname      eq,pres,sub
index uidNumber,gidNumber,loginShell    eq,pres
index uid,memberUid                     eq,pres,sub
index nisMapName,nisMapEntry            eq,pres,sub
```

删除slapd.d中的数据库配置文件,并通过slapd.conf重新生成slapd.d中的配置信息
```shell
rm -rf /etc/openldap/slapd.d/*
slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d
```

调整配置目录和数据库目录的权限，并启动slapd
```shell
chown -R ldap:ldap /etc/openldap/slapd.d
chown -R ldap:ldap /var/lib/ldap

systemctl restart slapd
```

### openldap打开日志信息
在配置文件里增加日志相关配置，这里的日志级别有很多种，值为256时会记录最多的日志信息。
```shell
# 日志文件路径
loglevel 256
logfile  /var/log/slapd/slapd.log
```

我们修改了配置文件slapd.conf，所以得重新生成配置数据库.
```shell
rm -rf /etc/openldap/slapd.d/*
slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d
chown -R ldap:ldap /etc/openldap/slapd.d
```

为了打开LDAP日志信息，需要修改rsyslog.conf，然后重启`rsyslog`服务。
```shell
vi  /etc/rsyslog.conf
local4.*   /var/log/slapd/slapd.log

systemctl restart rsyslog.service
```

最后重启slapd服务就可以看到日志信息了。
```shell
systemctl restart slapd
tail -f /var/log/slapd/slapd.log
```

### openldap管理用户
为ldap添加用户数据，有四种方法，分别如下：
* 直接修改directory下面的数据文件，好处是不用重启服务，直接生效；
* 安装开源工具migrationtools来生成ldfi文件，并通过ldapadd来添加；
* 安装ldap WEB客户端来可视化操作，这种方法最为简单；
* 直接编辑ldfi文件，然后通过ldapadd添加，这种方法最为常用。

通过ldfi文件来添加一个用户
```shell
cat << 'eof' > admin.ldif
dn: cn=admin,dc=daowoo,dc=com
objectclass: organizationalRole
cn: admin
eof

ldapadd -x -D "cn=admin,dc=daowoo,dc=com" -w bigdata -f admin.ldif
```

查询域下的所有用户
```shell
ldapsearch -x -D "cn=admin,dc=daowoo,dc=com" -h 192.168.85.196 -w bigdata -b 'dc=daowoo,dc=com'
ldapsearch -x -D "cn=admin,dc=daowoo,dc=com" -b "dc=daowoo,dc=com" -w bigdata
ldapsearch -x -b 'dc=daowoo,dc=com'
```

删除用户
```shell
ldapdelete -x -D "cn=admin,dc=bigdata,dc=com" -w bigdata "cn=admin,dc=bigdata,dc=com"
```

## LDAP安装WEB管理应用
在[LDAP Account Manager](https://www.ldap-account-manager.org/lamcms/releases)官网下载基于php的LAM 6.1资源包。

安装php以及httpd等依赖软件。
```shell
yum install -y httpd php php-ldap php-gd
rpm -qa httpd php php-ldap php-gd
```

解压LAM并移动到httpd默认的页面目录
```shell
tar -jxvf ldap-account-manager-6.1.tar.bz2
mv /root/ldap-account-manager-6.1 /var/www/html/ldap
```

修改LAM全局配置文件
```shell
cd /var/www/html/ldap/config
cp config.cfg.sample config.cfg

vi config.cfg
# default profile, without ".conf"
default: panhongfa
```

修改LAM服务配置文件
```shell
cd /var/www/html/ldap/config
cp addressbook.conf.sample panhongfa.conf

vi panhongfa.conf
ServerURL: ldap://sldap.daowoo.com:389
Admins: cn=admin,dc=bigdata,dc=com
treesuffix: dc=bigdata,dc=com
defaultLanguage: zh_CN.utf8
useTLS: no
```

调整LAM资源目录的权限，并重启httpd服务
```shell
chown -R apache:apache /var/www/html/ldap
systemctl restart httpd
```

## Hadoop集群账号导入LDAP
在GW主机上安装migrationtools导入/导出工具，利用migrationtools将系统账户导出成为ldif文件，然后再利用ldapadd命令添加
```shell
# 安装migrationtools
yum -y install migrationtools
```

在`/usr/share/migrationtools/`目录下有很多脚本文件，修改migrate_common.ph中如下配置
```shell
# Default DNS domain
$DEFAULT_MAIL_DOMAIN = "bigdata.wh.com";

# Default base
$DEFAULT_BASE = "dc=bigdata,dc=com";
```

生成centos系统基础信息的ldif数据文件
```shell
/usr/share/migrationtools/migrate_base.pl > centos.ldif
```

可以自己修改生成的centos.ldif文件，删除不必须的组织`ou`，然后再导入到LDAP。
```shell
# 如果之前添加过同名的ou，这一步会出现如下的错误
ldapadd -x -D "cn=admin,dc=bigdata,dc=com" -w bigdata -f centos.ldif
adding new entry "dc=bigdata,dc=com"
ldap_add: Already exists (68)

# 此时就需要使用-c参数来强制添加，注意两次添加过程返回的信息差异
ldapadd -c -x -D "cn=admin,dc=daowoo,dc=com" -h 192.168.85.196 -w bigdata -f centos.ldif
```

生成GW主机上的系统用户数据文件passwd.ldif和系统用户组数据文件group.ldif。
```shell
# 生成用户和用户组数据文件
/usr/share/migrationtools/migrate_passwd.pl /etc/passwd passwd.ldif
/usr/share/migrationtools/migrate_group.pl /etc/group group.ldif
```

同样可以自己修改passwd.ldif和group.ldif，只保留一部分用户和用户组信息
```
vi passwd.ldif
...
dn: uid=hdfs,ou=People,dc=bigdata,dc=com
uid: hdfs
cn: hdfs
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17457
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 1007
gidNumber: 1001
homeDirectory: /home/hdfs
...

vi group.ldif
...
dn: cn=hdfs,ou=Group,dc=bigdata,dc=com
objectClass: posixGroup
objectClass: top
cn: hdfs
userPassword: {crypt}x
gidNumber: 1002
...
```

将用户和用户组导入LDAP，这里进行的导入操作主要是为了获取用户和用户组的objectClass等节点属性
```shell
ldapadd -c -x -D "cn=admin,dc=daowoo,dc=com" -h 192.168.85.196 -w bigdata -f passwd.ldif
ldapadd -c -x -D "cn=admin,dc=daowoo,dc=com" -h 192.168.85.196 -w bigdata -f group.ldif
```

## 访问LAM页面来管理LDAP
浏览器访问URL`http://hostname/ldap/`，使用前面建立的LDAP管理员用户和密码来登录LAM。
